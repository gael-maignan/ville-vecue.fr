<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Elles dans la Ville — Carte</title>

  <!-- Leaflet CSS -->
  <link rel="preload" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" as="style">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

  <!-- MarkerCluster CSS -->
  <link rel="preload" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" as="style">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">

  <meta name="viewport" content="width=device-width,initial-scale=1">

  <script type="module" src="https://gael-mgn.github.io/js/log.js"></script>


  <style>
    :root{--bg:#FFEBD8;--header:#FFEBD8;--text:#000A47}
    *{box-sizing:border-box;margin:0;padding:0;}
    body{background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;
    font-family: "Libre Franklin", sans-serif;}
    header{padding:1rem;background:var(--header);color:#000A47;text-align:center}
    h1 {
      margin-bottom: 0.5rem;
    }
    #map{flex:1;height:calc(100vh - 88px);width:100%}
    #loader{
      position:absolute;top:1rem;right:1rem;
      background:rgba(255,255,255,.9);padding:.5rem .75rem;border-radius:6px;
      box-shadow:0 2px 8px rgba(0,0,0,.12);
      font-size:.9rem;z-index:1000;display:none
    }
    .leaflet-popup-content h3{margin-bottom:.3rem;font-size:1.05rem}
    .leaflet-popup-content p{font-size:.9rem;margin-bottom:.25rem}


/* Popup : fond beige + texte bleu marine */
.leaflet-container .leaflet-popup-content-wrapper {
  background: #FFEBD8;         /* fond beige (root var déjà défini) */
  color: #000A47;              /* texte bleu marine */
  border-radius: 10px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.15);
  font-family: "Libre Franklin", system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
  padding: 10px 12px;
  border: 1px solid rgba(0,10,71,0.06);
  max-width: 320px;            /* évite popups trop larges */
}

/* Titre et paragraphes à la couleur voulue */
.leaflet-popup-content-wrapper .leaflet-popup-content h3,
.leaflet-popup-content-wrapper .leaflet-popup-content p,
.leaflet-popup-content-wrapper .leaflet-popup-content strong {
  color: #000A47;
}

/* Flèche (tip) du popup : même beige que le wrapper */
.leaflet-container .leaflet-popup-tip-container .leaflet-popup-tip {
  fill: #FFEBD8;
}

/* Bouton fermer : discret, bleu marine */
.leaflet-popup-close-button {
  color: #000A47;
  opacity: 0.9;
  text-shadow: none;
  font-size: 1.05rem;
  right: 8px;
  top: 6px;
}

/* Liens dans le popup (si présents) */
.leaflet-popup-content-wrapper a {
  color: #000A47;
  text-decoration: underline;
}

/* Petite amélioration responsive : réduire la largeur sur mobile */
@media (max-width: 420px) {
  .leaflet-popup-content-wrapper { max-width: 86vw; padding: 8px 10px; }
}





/* Cluster bleu marine avec texte beige - version centrée et responsive */
.marker-cluster-blue {
  /* wrapper de Leaflet : on laisse transparent pour contrôler l'apparence via le div intérieur */
  background: transparent;
  border: 0;
  box-shadow: none;
  padding: 0;
}

/* Le cercle visible (div intérieur généré dans html) */
.marker-cluster-blue > div {
  display: inline-flex;             /* flex pour centrer facilement */
  align-items: center;
  justify-content: center;
  min-width: 44px;                   /* largeur minimale */
  min-height: 44px;                  /* hauteur minimale */
  padding: 6px 8px;                  /* laisse de la place pour 2-3 chiffres */
  border-radius: 50%;                /* cercle */
  background-color: #FFEBD8;         /* bleu marine */
  color: #000A47;                    /* beige */
  border: 3px solid #000A47;         /* contour blanc */
  font-weight: 700;
  font-size: 14px;
  line-height: 1;                    /* évite décalage vertical */
  box-shadow: 0 2px 6px rgba(0,0,0,0.25);
  white-space: nowrap;               /* empêche le texte de se casser */
  text-align: center;
  transform-origin: center;
}

/* Ajuste si beaucoup de marqueurs (optionnel visuel) */
.marker-cluster-blue.large > div {
  min-width: 56px;
  min-height: 56px;
  font-size: 15px;
  padding: 8px 10px;
}

/* Le span qui contient le nombre */
.marker-cluster-blue span {
  display: block;
  padding: 0;
  margin: 0;
}

/* petite animation au hover (facultative) */
.marker-cluster-blue:hover > div {
  transform: scale(1.06);
}








/* Pastille simple pour les marqueurs individuels */
.marker-dot {
  width: 16px;
  height: 16px;
  background-color: #000A47;   /* bleu marine */
  border-radius: 50%;
  border: 2px solid #FFEBD8;   /* léger liseré clair */
  box-shadow: 0 1px 4px rgba(0,0,0,0.35);
}

  </style>
</head>

<body>
  <!--<header>
    <h1>Elles dans la Ville</h1>
    <p>Explorez la mémoire féminine de Paris</p>
  </header>-->

  <div id="map" aria-label="Carte des plaques commémoratives"></div>
  <div id="loader" role="status" aria-live="polite">Chargement…</div>

  <!-- Loader robuste Leaflet + MarkerCluster + init carte -->
  <script>



  (function () {

    const SCRIPTS = [
      {
        src: "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js",
        check: () => window.L
      },
      {
        src: "https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js",
        check: () => window.L && L.MarkerClusterGroup
      }
    ];

    function loadScript(src, timeout = 10000) {
      return new Promise((resolve, reject) => {
        if (document.querySelector(`script[data-src="${src}"]`)) return resolve();

        const s = document.createElement("script");
        s.src = src;
        s.async = false;
        s.dataset.src = src;

        s.onload = resolve;
        s.onerror = () => reject(new Error("Erreur chargement " + src));

        document.head.appendChild(s);

        setTimeout(() => reject(new Error("Timeout " + src)), timeout);
      });
    }

    (async function init() {
      try {
        for (const s of SCRIPTS) {
          await loadScript(s.src);
          const start = Date.now();
          while (!s.check()) {
            if (Date.now() - start > 3000) break;
            await new Promise(r => setTimeout(r, 50));
          }
        }
      } catch (e) {
        console.error("Échec chargement Leaflet", e);
        return;
      }

      const DATA_URL = "https://gael-mgn.github.io/divers/plaques_commemoratives.json";
      const loader = document.getElementById("loader");
      const showLoader = v => loader.style.display = v ? "block" : "none";

      const map = L.map("map").setView([48.8566, 2.3522], 12);

      const dotIcon = L.divIcon({
  className: '',
  html: '<div class="marker-dot"></div>',
  iconSize: [12, 12],
  iconAnchor: [6, 6] // centre exact
});

L.tileLayer(
  "https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png",
  {
    attribution: "&copy; OpenStreetMap &copy; CARTO",
    subdomains: "abcd",
    maxZoom: 19
  }
).addTo(map);



const clusterGroup = L.markerClusterGroup({
  chunkedLoading: true,
  showCoverageOnHover: false, // <-- désactive l'ombrage/zone au survol
  iconCreateFunction: function (cluster) {
    const count = cluster.getChildCount();
    const extraClass = count > 99 ? ' large' : '';
    const html = `<div><span>${count}</span></div>`;
    return L.divIcon({
      html: html,
      className: 'marker-cluster marker-cluster-blue' + extraClass,
      iconSize: L.point(44, 44),
      iconAnchor: L.point(22, 22)
    });
  }
});


      clusterGroup.addTo(map);

      showLoader(true);

      fetch(DATA_URL)
        .then(r => r.json())
        .then(features => {
          features.forEach(p => {
            const { lat, lon } = p.geo_point_2d || {};
            if (!lat || !lon) return;

            const marker = L.marker([lat, lon], { icon: dotIcon });

            marker.bindPopup(`
                      <h3>${p.titre ?? 'Plaque commémorative'}</h3>
        <p><strong>Adresse :</strong> ${p.adresse ?? '—'}</p>
        <p><strong>Arrt :</strong> ${p.ardt ?? '—'}</p>
        <p><strong>Personnalité :</strong> ${p.personnalite ?? '—'}</p>
        <p><strong>Période :</strong> ${p.periode_1 ?? p.siecle ?? '—'}</p>
        <p><strong>Matériau :</strong> ${p.materiau ?? '—'}</p>
        <p>${p.retranscription ?? ''}</p>
            `);
            clusterGroup.addLayer(marker);
          });
          showLoader(false);
        })
        .catch(err => {
          console.error("Erreur données", err);
          showLoader(false);
        });
    })();

  })();
  </script>
</body>
</html>
